const SPREADSHEET_ID = "1mhz-9W_T9x9AhZtSoXnLFs3dlRigSpVKdQYSCqHJ_a8";
const SHEET_NAME = "Orders";

const HEADERS = [
  "Timestamp",
  "SteamID",
  "Plan",
  "Months",
  "Crypto",
  "Amount",
  "TXID",
  "Page",
  "UserAgent"
];

function doGet(e)  { return handle_(e); }
function doPost(e) { return handle_(e); }

// (Optional) Helps if you ever switch to fetch() later
function doOptions(e){
  return ContentService
    .createTextOutput("")
    .setMimeType(ContentService.MimeType.TEXT);
}

function handle_(e) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(20000);

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sh = getOrUseSingleSheet_(ss);

    const data = parseAny_(e);

    // Accept common variants so it's never "missing"
    const steamId = String(
      pickFirst_(data, ["steamId","steamid","steamID","SteamID","SteamId","steam"]) || ""
    ).trim();

    // Health check: opening /exec with no params says ok (no writes)
    if (!steamId) return text_("ok");

    const row = [
      new Date(),
      steamId,
      String(pickFirst_(data, ["plan","Plan"]) || ""),
      String(pickFirst_(data, ["months","Months"]) || ""),
      String(pickFirst_(data, ["crypto","Crypto"]) || ""),
      String(pickFirst_(data, ["amount","Amount"]) || ""),
      String(pickFirst_(data, ["txid","TXID","txId","txID"]) || ""),
      String(pickFirst_(data, ["page","Page"]) || ""),
      String(pickFirst_(data, ["ua","userAgent","UserAgent"]) || "")
    ];

    sh.appendRow(row);

    const lastRow = sh.getLastRow();
    sh.getRange(lastRow, 1).setNumberFormat("yyyy-mm-dd hh:mm:ss");

    SpreadsheetApp.flush();
    return text_("ok");
  } catch (err) {
    // return the message so you can see what's wrong instantly if anything fails
    return text_("error: " + (err && err.message ? err.message : err));
  } finally {
    try { lock.releaseLock(); } catch (_) {}
  }
}

/* -----------------------
   Sheet selection + styling
   ----------------------- */

// Uses your ONLY tab, renames it to "Orders"
function getOrUseSingleSheet_(ss) {
  let sh = ss.getSheetByName(SHEET_NAME);
  if (!sh) {
    const sheets = ss.getSheets();
    sh = (sheets && sheets.length) ? sheets[0] : ss.insertSheet(SHEET_NAME);
    if (sh.getName() !== SHEET_NAME) sh.setName(SHEET_NAME);
  }
  ensureHeadersAndStyle_(sh);
  return sh;
}

function ensureHeadersAndStyle_(sh) {
  const neededCols = HEADERS.length;

  if (sh.getMaxColumns() < neededCols) {
    sh.insertColumnsAfter(sh.getMaxColumns(), neededCols - sh.getMaxColumns());
  }

  // Set headers once (or repair if missing)
  const current = sh.getLastRow() >= 1
    ? sh.getRange(1, 1, 1, neededCols).getValues()[0]
    : [];

  const mismatch = HEADERS.some((h, i) => String(current[i] || "").trim() !== h);

  if (sh.getLastRow() === 0) {
    sh.getRange(1, 1, 1, neededCols).setValues([HEADERS]);
  } else if (mismatch) {
    sh.getRange(1, 1, 1, neededCols).setValues([HEADERS]);
  }

  sh.setFrozenRows(1);

  const headerRange = sh.getRange(1, 1, 1, neededCols);
  headerRange.setFontWeight("bold").setFontSize(10).setVerticalAlignment("middle");

  if (!sh.getFilter()) headerRange.createFilter();

  const widths = [165, 190, 110, 80, 95, 85, 240, 260, 360];
  widths.forEach((w, i) => sh.setColumnWidth(i + 1, w));

  if (sh.getLastRow() > 1) {
    sh.getRange(2, 1, sh.getLastRow() - 1, 1).setNumberFormat("yyyy-mm-dd hh:mm:ss");
  }
}

/* -----------------------
   Parsing (GET + POST)
   ----------------------- */

function parseAny_(e) {
  const params = (e && e.parameter) ? e.parameter : {};
  const body = parseBody_(e);
  return Object.assign({}, params, body);
}

function parseBody_(e) {
  let data = {};
  try {
    const raw = (e && e.postData && e.postData.contents) ? e.postData.contents : "";
    const ct  = (e && e.postData && e.postData.type) ? e.postData.type : "";

    if (ct.includes("application/json")) {
      return JSON.parse(raw || "{}");
    }

    (raw || "").split("&").forEach(pair => {
      const [k, v] = pair.split("=");
      if (!k) return;
      data[decodeURIComponent(k)] = decodeURIComponent((v || "").replace(/\+/g, " "));
    });
  } catch (_) {}

  return data;
}

function pickFirst_(obj, keys){
  for (var i=0; i<keys.length; i++){
    var k = keys[i];
    if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== ""){
      return obj[k];
    }
  }
  return "";
}

/* -----------------------
   Response helper
   ----------------------- */

function text_(s) {
  return ContentService
    .createTextOutput(String(s))
    .setMimeType(ContentService.MimeType.TEXT);
}
